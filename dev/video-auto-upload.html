<style>
    html, body {
        margin: 0!important;
        padding: 0!important;
    }
</style>

<title>Video Recording | RecordRTC</title>
<h1>Simple Video Recording using RecordRTC</h1>

<br>

<button id="btn-start-recording">Start Recording</button>
<button id="btn-stop-recording" disabled>Stop Recording</button>

<hr>
<video controls autoplay playsinline id="my-preview"></video>
<p id="percentage"></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.5.9/RecordRTC.js"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.12.min.js"></script>
<script>
var recorder; // globally accessible
var video = document.getElementById('my-preview');

var bucketName = 'resilient-ai';
var bucket = new AWS.S3({
	params: {
		Bucket: bucketName
	}
});

AWS.config.region = 'us-east-1';
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
    IdentityPoolId: 'us-east-1:8b110ca3-b5d0-478f-8df8-e864d62807f2'
});
AWS.config.credentials.get(function(err) {
	if (err) alert(err);
	console.log(AWS.config.credentials);
});

function captureCamera(callback) {
    navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(function(camera) {
        callback(camera);
    }).catch(function(error) {
        alert('Unable to capture your camera. Please check console logs.');
        console.error(error);
    });
}

function uploadRecorder(callback) {
    recorder.getDataURL(callback, recorder)
}

function base64EncodeUnicode(str) {
    // First we escape the string using encodeURIComponent to get the UTF-8 encoding of the characters, 
    // then we convert the percent encodings into raw bytes, and finally feed it to btoa() function.
    utf8Bytes = encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
            return String.fromCharCode('0x' + p1);
    });

    return btoa(utf8Bytes);
}

function dataURLtoFile(dataurl, filename) {
		var arr = dataurl.split(','), 
			mime = arr[0].match(/:(.*?);/)[1],
			bstr = atob(base64EncodeUnicode(arr[1])), 
			n = bstr.length, 
			u8arr = new Uint8Array(n);
		while(n--){
			u8arr[n] = bstr.charCodeAt(n);
		}
		return new File([u8arr], filename, {type:mime});
}

function stopRecordingCallback() {
    video.src = video.srcObject = null;
    video.muted = false;
    video.volume = 1;
    video.src = URL.createObjectURL(recorder.getBlob());

    uploadRecorder(function(result) {
		console.log('starting packaging...')

	    var random = Math.random( ); 
		var url_file = dataURLtoFile(result, random +'.webm');
	    var objKey = 'video/user/web/' + url_file.name;
		var params = {
			Key: objKey,
			ContentType: url_file.type,
			Body: url_file,
			ACL: 'public-read'
		};

// 		WHERE IS THE FILE ENDING UP????
		var request = bucket.putObject(params);
		request.on('httpUploadProgress', function (progress) {
			percentage.innerHTML = parseInt((progress.loaded * 100) / progress.total)+'%'; 
			console.log("Uploaded :: " + parseInt((progress.loaded * 100) / progress.total)+'%');
		   // console.log(progress.loaded + " of " + progress.total + " bytes");
		}).send(function(err, data){
			percentage.innerHTML = "File has been uploaded successfully.";
		});
		
		console.log(url_file.type, url_file)
    });
    
    recorder.camera.stop()
    recorder.destroy();
    recorder = null;
}

document.getElementById('btn-start-recording').onclick = function() {
    this.disabled = true;
    captureCamera(function(camera) {
        video.muted = true;
        video.volume = 0;
        video.srcObject = camera;

        recorder = RecordRTC(camera, {
            type: 'video'
        });

        recorder.startRecording();

        // release camera on stopRecording
        recorder.camera = camera;

        document.getElementById('btn-stop-recording').disabled = false;
    });
};

document.getElementById('btn-stop-recording').onclick = function() {
    this.disabled = true;
    recorder.stopRecording(stopRecordingCallback);
    document.getElementById('btn-start-recording').disabled = false;
};
</script>

<footer style="margin-top: 20px;"><small id="send-message"></small></footer>
